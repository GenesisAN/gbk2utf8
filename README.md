# GBK 转 UTF-8 工具（自动识别编码）

这是一个基于 Rust 编写的命令行工具，可用于**批量扫描目录下的代码文件**，**识别并转换 GBK 编码为 UTF-8**，个人用于项目编码统一。

---

## ✨ 功能特性

* ✅ 自动识别文件编码（支持 UTF-8 / GBK 等）
* ✅ 识别 UTF-8 文件，避免误转码
* ✅ 可递归扫描子目录
* ✅ 支持指定要转换和识别的文件扩展名
* ✅ 支持转换前备份 `.bak`
* ✅ 可显示每个文件的编码猜测和置信度

---

## 📦 编译方式

### 使用 `cargo` 构建

```bash
git clone https://github.com/yourname/gbk2utf8.git
cd gbk2utf8
cargo build --release
./target/release/gbk2utf8
```

---

## 🚀 使用示例

### 转换当前目录下所有 `.c` 和 `.h` 文件

```bash
./gbk2utf8
```
⚠️ 警告：❗转换操作具有破坏性，建议始终备份原文件。

备份功能 默认关闭，如果需要备份，请使用 `-b` 或 `--backup` 参数。
### 扫描 `src/` 目录，显示编码信息但不转换：

```bash
./gbk2utf8 -d ./src -i -s
```

### 转换 `.txt` 文件，启用备份：

```bash
./gbk2utf8 -e "txt" -b
```

---

## 🔧 命令行参数说明

| 参数                           | 说明                                 |
| ---------------------------- | ---------------------------------- |
| `-d, --dir <路径>`             | 要扫描的目录，默认是当前目录，支持递归子目录             |
| `-e, --extensions <扩展名,...>` | 只处理指定扩展名的文件（默认：`c,h`），多个用英文逗号分隔    |
| `-s, --scan-only`            | 仅扫描，不执行转换                          |
| `-b, --backup`               | 转换前为每个文件备份为 `.bak`                 |
| `-i, --show-info`            | 显示每个文件的编码检测信息与置信度                  |
| `-m, --min-confidence <数值>`  | 置信度阈值（0～1），低于该值不会视为 GBK，默认 0.8     |
| `--t <TLD>`                  | 顶级域名（如 `cn`、`jp`）用于提高识别准确度，默认 `cn` |

---

## 🧠 原理说明

### 📍 文件编码识别逻辑

工具使用 [`chardetng`](https://github.com/hsivonen/chardetng) 识别编码，流程如下：

1. **尝试将文件内容解析为 UTF-8**：

   * 如果成功，直接认定是 UTF-8，无需转换。
   * 这样可以防止将本就是 UTF-8 的文件误判成 GBK 并错误转码。

2. **使用 chardetng 猜测编码**：

   * 基于字节模式、语言特征（如 `--t cn`）进行启发式分析。
   * 如果识别为 `GBK` 且置信度超过设定值（如 `0.8`），则判定为 GBK。

### 📦 备份逻辑

如果开启 `--backup`，转换前会自动复制原文件为 `.bak` 文件，保留原始内容。

例如：

```text
main.c -> main.c.bak
```

---

## 🛡️ 为什么能防止误转换？

相比直接依赖编码识别工具的猜测结果，该工具优先做了：

* ✅ UTF-8 解码合法性验证（防误判）
* ✅ 支持自定义置信度阈值（防误杀）
* ✅ 显示每个文件识别详情供人工决策

---

## 🧪 支持识别的编码

虽然工具只转换 GBK，但能识别包括：

* UTF-8
* GBK / GB2312 / GB18030（作为 GBK 的超集）
* Shift-JIS、EUC-KR 等（被排除）

---

## 💬 示例输出（含 `--show-info`）

```text
./src/main.c: 明确是 UTF-8，跳过
./lib/legacy.c: 猜测编码 = gbk, 置信度 = 1.00，已转换
./old/driver.c: 猜测编码 = windows-1252, 置信度 = 0.50，跳过
```

